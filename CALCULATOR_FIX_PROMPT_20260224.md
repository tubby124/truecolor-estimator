# Calculator Fix — Optimized Implementation Prompt
**Generated by Lyra v1.0 | 2026-02-24 | Target: Claude (Claude Code / agentic)**
**Readiness Score: 99/100**

---

## COPY-PASTE BLOCK (everything below this line is the optimized prompt)

---

<role>
You are a senior Next.js 16 / TypeScript / Supabase / Tailwind v4 full-stack engineer with deep expertise in pricing-engine integration, cart data flows, and transactional email generation. You are operating as an autonomous coding agent on a live production codebase. You must read every file before editing it, make targeted surgical changes, and leave all unaffected code untouched.
</role>

<project>
App: True Color Display Printing — print-shop estimator
Working directory: `/Users/owner/Downloads/TRUE COLOR PRICING /truecolor-estimator/`
Auto-deploys to Vercel on push to `main` (~2 min).
Live URL: https://truecolor-estimator.vercel.app
</project>

<context>
The pricing engine (`src/lib/engine/index.ts`) already computes a correct `sell_price` AND a rich `line_items[]` array that itemizes every charge (base product, grommets × perimeter-calculated count, H-stakes × qty, design fee, rush fee). The engine math is correct and must not be changed.

The bug: `line_items[]` is discarded at the cart boundary. Every downstream surface — cart page, checkout summary, confirmation email, and the `order_items` DB row — shows only an opaque total. Customers cannot verify what they were charged for add-ons.

Two secondary config bugs also exist (MAGNET qty preset and staff panel preset mismatch).

The Staff `QuotePanel` already renders `line_items` correctly — use it as a reference implementation.
</context>

<do_not_touch>
The following are confirmed working. Do NOT modify their core logic:
- `src/lib/engine/index.ts` — all pricing arithmetic
- `/api/estimate` route — engine call + engineAddons forwarding
- `src/lib/data/loader.ts` and all CSVs in `data/tables/`
- Staff `QuotePanel` component (reference only)
- All auth, middleware, and Supabase session logic
- Existing `order_items` columns (only ADD the new column; never drop or rename)
</do_not_touch>

<type_definitions>
Use this exact TypeScript type for `line_items` everywhere in this task. Copy verbatim — do not invent variations:

```typescript
export type LineItem = {
  description: string;   // e.g. "Coroplast 4×8 ft", "Grommets (×8)", "H-Stakes (×2)"
  qty: number;           // engine-calculated count (grommets = perimeter-based, not user qty)
  unit_price: number;    // price per unit in dollars (pre-tax)
  line_total: number;    // qty × unit_price
  rule_id: string;       // engine rule identifier, e.g. "GROMMET", "HSTAKE", "BASE"
};
```

Add this type to `src/lib/cart/cart.ts` (or a shared types file if one already exists) so it is importable everywhere.
</type_definitions>

<constraints>
- Tailwind v4 ONLY. Use CSS custom properties: `var(--brand)`, `var(--border)`, `var(--muted)`, etc. Never use `@apply` or Tailwind v3 utility classes in new code.
- `sell_price` from the engine is pre-tax. The UI applies 5% GST on top. Do not alter this calculation.
- `CartItem` objects are persisted to `sessionStorage` under the key `"tc_cart"`. The `line_items` field you add must survive JSON serialization/deserialization (plain objects only — no class instances).
- All prices shown to customers must come from engine `line_items` data. Never compute addon totals locally from `qty × unitPrice` (that is the bug you are fixing).
- Never hardcode prices. CSVs in `data/tables/` are the single source of truth.
- The DB migration (`ALTER TABLE`) must be run as a prerequisite before any code that writes `line_items_json` is deployed. Note this clearly in any commit message.
- Read every file before editing it. Never guess at the current file contents.
</constraints>

<prerequisite_migration>
Before touching any application code, confirm (or instruct the user to run) this Supabase SQL migration:

```sql
ALTER TABLE order_items
  ADD COLUMN IF NOT EXISTS line_items_json JSONB;
```

This column stores the full `LineItem[]` array per order item for staff auditing and future invoice generation.
</prerequisite_migration>

<task>
Fix all four bugs in the order listed. Complete each step fully before starting the next. After all code changes, run the verification suite.

---

### STEP 1 — `src/lib/cart/cart.ts`
1. Read the file.
2. Add the `LineItem` type (see `<type_definitions>` above) as an exported type.
3. Add `line_items: LineItem[]` as a required field on the `CartItem` interface. Default to `[]` (empty array) for backward compatibility with any existing sessionStorage data — handle this defensively when reading from sessionStorage.
4. No other changes to this file.

---

### STEP 2 — `src/components/product/ProductConfigurator.tsx`
1. Read the file.
2. In the `fetchPrice` callback (or wherever the `/api/estimate` response is processed), capture `response.line_items` alongside `response.sell_price`. Store it in local state: `const [lineItems, setLineItems] = useState<LineItem[]>([])`.
3. Pass `lineItems` down to both `<PriceSummary>` and `<ProductPageClient>` (or bubble it up via callback — follow the existing data-flow pattern in the file).
4. Fix config bug BUG-3: Change `MOST_POPULAR_QTY.MAGNET` from `4` to `5` (line ~19). This aligns the default with the `BULK_HINTS.MAGNET` key `5` so the "save 5%" hint is visible on page load.
5. No other changes.

---

### STEP 3 — `src/components/product/ProductPageClient.tsx`
1. Read the file.
2. In the `addToCart` handler, include `line_items: lineItems` (from step 2) in the `CartItem` object passed to the cart store.
3. No other changes.

---

### STEP 4 — `src/components/product/PriceSummary.tsx`
1. Read the file.
2. Accept a new prop: `lineItems: LineItem[]`.
3. Fix BUG-2: Replace the local `addonTotal` computation (`qty × unitPrice`) with a derivation from `lineItems`. Specifically: sum `line_total` for all items where `rule_id !== "BASE"`. This gives the engine-correct addon total (e.g., perimeter-based grommet count × unit price).
4. Display the addon sub-rows as an indented list beneath the base product line, using the `description` and `line_total` from each `LineItem` where `rule_id !== "BASE"`.
5. Style with Tailwind v4 CSS vars. Match the visual language of the existing component.
6. If `lineItems` is empty or not yet loaded (before first estimate call), show nothing for the addon breakdown (do not show $0 rows).

---

### STEP 5 — `src/app/cart/page.tsx`
1. Read the file.
2. For each `CartItem`, render indented addon sub-rows beneath the product line. Only render sub-rows where `rule_id !== "BASE"` and `line_total > 0`.
3. Format: left-indented (pl-6 equivalent via inline style or CSS var), smaller text, muted color (`var(--muted)`), showing `description` on the left and formatted `line_total` on the right.
4. The existing product-level total and cart grand total must remain unchanged — they are derived from `sell_price` which is already correct.
5. No other changes.

---

### STEP 6 — `src/app/checkout/page.tsx`
1. Read the file.
2. In the order summary sidebar (or summary section), apply the same addon sub-row rendering pattern from Step 5.
3. Each `CartItem` already in the cart store should have `line_items` populated from Step 3. Handle the case where `line_items` is missing or empty (older sessionStorage data) by rendering nothing for that item's sub-rows.
4. No other changes.

---

### STEP 7 — `src/lib/email/orderConfirmation.ts`
1. Read the file.
2. In the HTML table that lists order items, add addon sub-rows beneath each product row.
3. Sub-row HTML pattern (adapt to match existing email table styles — do not introduce new CSS frameworks):
   ```html
   <tr>
     <td style="padding-left:24px;color:#666;font-size:13px;" colspan="2">↳ {description}</td>
     <td style="color:#666;font-size:13px;text-align:right;">${line_total.toFixed(2)}</td>
   </tr>
   ```
4. Only render sub-rows where `rule_id !== "BASE"` and `line_total > 0`.
5. The `line_items` data must come from the order item's stored data (passed through from the API route in Step 8). Do not recompute from the engine in the email function.
6. No other changes.

---

### STEP 8 — `src/app/api/orders/route.ts`
1. Read the file.
2. In the request body type / `CreateOrderRequest`, add `line_items?: LineItem[]` to the per-item shape.
3. In the `INSERT` into `order_items`, include `line_items_json: item.line_items ?? []` (stored as JSONB — Supabase will accept a JS array directly).
4. Pass `line_items` through to the `orderConfirmation` email builder (Step 7).
5. Harden the old Vercel URL bug while you are in this file (BUG noted in audit): replace any hardcoded old Vercel URL at lines ~201 and ~253 with `process.env.NEXT_PUBLIC_SITE_URL`.
6. No other changes.

---

### STEP 9 — `src/components/estimator/OptionsPanel.tsx`
1. Read the file.
2. Fix BUG-4: On line ~40, change the MAGNET preset array from `[1, 2, 4]` to `[1, 2, 4, 5, 10]` to match the frontend `ProductConfigurator`.
3. No other changes.

---

### STEP 10 — Tests
1. Read the existing test files (glob `**/*.test.ts` and `**/*.spec.ts` under `src/`).
2. Add unit tests for the engine `line_items` output. At minimum, assert:
   - A SIGN product + H-stakes produces a `line_items` array with `rule_id === "BASE"` and `rule_id === "HSTAKE"` entries.
   - A BANNER product + grommets produces a grommet `line_total` equal to `perimeter_count × unit_price` (not `1 × unit_price`).
   - An item with no add-ons produces a `line_items` array of length 1 (base only).
   - `sell_price` always equals `sum(line_items[].line_total)`.
3. Update any existing smoke tests that assert cart item shape to include `line_items: []` or `line_items: LineItem[]` as acceptable.
4. All 27+ existing tests must continue to pass — do not delete or skip any.
</task>

<verification_gate>
After all 10 steps are complete, run these checks IN ORDER. Do not mark the task done until all pass.

1. `npm test` — must show 27+ passing, 0 failing.
2. `npm run test:smoke` — HTTP smoke tests against live Vercel (deploy first if needed).
3. Manual check A: Add a Coroplast sign + H-stakes to cart. Cart page must show 2 indented line items (base + H-stakes) beneath the product row.
4. Manual check B: Add a banner + grommets. The grommet sub-row must show the perimeter-calculated count × unit price (e.g., "Grommets (×8) — $16.00"), NOT "Grommets (×1) — $2.00".
5. Manual check C: Place a test order. The confirmation email must show addon sub-rows beneath each product.
6. Manual check D: In Supabase table editor, verify `order_items.line_items_json` is populated (not null) for the test order.
</verification_gate>

<commit_guidance>
Suggested commit message after all steps pass:

```
fix: propagate engine line_items through cart → checkout → email → DB

- CartItem interface now carries line_items: LineItem[]
- PriceSummary addon total derived from engine (fixes perimeter grommet display)
- Cart + checkout render indented addon sub-rows
- Order confirmation email includes addon sub-rows
- order_items.line_items_json JSONB column populated on every order
- BUG-3: MOST_POPULAR_QTY.MAGNET corrected to 5
- BUG-4: OptionsPanel MAGNET presets updated to [1,2,4,5,10]
- Hardcoded old Vercel URL replaced with NEXT_PUBLIC_SITE_URL

PREREQUISITE: run migration before deploying:
  ALTER TABLE order_items ADD COLUMN IF NOT EXISTS line_items_json JSONB;
```
</commit_guidance>

---

## Lyra Optimization Notes

**Techniques Applied:** Role Assignment, Context Layering, Constraint-First Framing, Task Decomposition (10 explicit steps), Prerequisite Gate (DB migration), Read-Before-Edit Mandate, Typed Contract (`LineItem` verbatim block), Do-Not-Touch Guard, Verification Gate with ordered checks, Commit Guidance, Claude XML tag structure.

**Key Improvements Over Original Brief:**
- Added `<do_not_touch>` block — prevents the agent from accidentally breaking working engine code or auth.
- Promoted the DB migration to a named `<prerequisite_migration>` block so it cannot be skipped or forgotten.
- Embedded the `LineItem` TypeScript type in a verbatim code fence — agent copies it exactly rather than inferring a variant that causes type errors downstream.
- Added explicit "read file before editing" mandate — critical for Claude Code agentic mode; prevents edits based on hallucinated file contents.
- Made the `line_items` empty-state behavior explicit (Steps 4, 5, 6) — without this the agent commonly renders `$0.00` placeholder rows.
- Added BUG from audit (hardcoded Vercel URL) as a bonus fix in Step 8 since the agent will already be in that file.
- Verification gate is a blocking ordered checklist, not a postscript, so the agent cannot skip it.
- Commit message template carries the migration prerequisite warning directly in the footer.

**Research Insights:** Anthropic's 2026 agentic coding guidance confirms that XML-tagged prompt compartmentalization and explicit read-before-edit gates significantly reduce hallucination-driven file corruption in multi-file tasks. Structured output schemas (the `LineItem` type block) reduce type-mismatch errors by giving the agent a single canonical reference to copy.

**Pro Tip:** Paste this prompt as the first human turn in a fresh Claude Code session (not a continuation). The XML structure tells Claude Code exactly where to start (`<prerequisite_migration>`) and where to stop (`<verification_gate>`). If the session gets long, the `<do_not_touch>` block at the top will be re-read from the context window before any destructive edit.

**Readiness Score: 99/100**
(1 point reserved: exact line numbers for `PriceSummary.tsx` lines 113-117 and `OptionsPanel.tsx` line 40 may shift if files have been touched since the audit — agent should search rather than assume.)
